---
title: "So You Want To Play In The NBA..."
author: "Team 8"
date: "April 23, 2019"
output: html_document
---

```{r warning=FALSE, include=FALSE}
#Anything in here will not show up when knitted
library(ggplot2)
library(dplyr)
library(tidyverse)
library(lubridate)
playerData <- read.csv("player_data.csv")
players <- read.csv("Players.csv")
seasonStats <- read.csv("Seasons_Stats.csv")
seasonStats <- seasonStats[-c(22,27)]
colnames(playerData)[colnames(playerData) == "name"] <- "Player"
colnames(playerData)[colnames(playerData) == "position"] <- "Pos"
players <- players[,-1]
playerStats <- left_join(playerData, players, by = "Player")
colSums(is.na(seasonStats))
play <- left_join(playerStats, seasonStats, by = "Player" )
nums_only <- play[tail(seq_along(play), 42)]
nums_only <- cbind(nums_only, play$Year, play$MP, play$G)
nums_only <- rename(nums_only, 'Year'='play$Year', 'MP'='play$MP','G'='play$G')
stats_2017_30_min <- nums_only %>%
  mutate(min_avg = MP/G) %>%
  filter(Year == 2017, min_avg >= 30)
stats_2017_30_min <- na.omit(stats_2017_30_min)
# scale values
maxs <- apply(stats_2017_30_min, 2, max)
mins <- apply(stats_2017_30_min, 2, min)
nums_scaled <- scale(stats_2017_30_min, center = mins, scale = maxs - mins)
nums_scaled <- nums_scaled[ ,order(colSums(nums_scaled))]
colSums(nums_scaled)
salaries <- read.csv('nba_salaries_1990_to_2018.csv')
all_data <- left_join(play, salaries, by = "Player")
teams <- read.csv("nba.games.stats.csv")
team_stats <- teams[,-1]
colnames(team_stats)[colnames(team_stats) == "FieldGoals."] <- "FieldGoals_PRCT"
colnames(team_stats)[colnames(team_stats) == "X3PointShots."] <- "X3PointShots_PRCT"
colnames(team_stats)[colnames(team_stats) == "FreeThrows."] <- "FreeThrow_PRCT"
colnames(team_stats)[colnames(team_stats) == "Opp.FieldGoals."] <- "Opp.FieldGoal_PRCT"
colnames(team_stats)[colnames(team_stats) == "Opp.3PointShots."] <- "Opp.3PointShot_PRCT"
colnames(team_stats)[colnames(team_stats) == "Opp.FreeThrows."] <- "Opp.FreeThrow_PRCT"
teams <- teams %>%
  mutate(Date = ymd(Date)) %>% 
  mutate_at(vars(Date), funs(year, month, day))
names(all_data) <- gsub(x = names(all_data), pattern = "\\.y", replacement = "_Y")
names(all_data) <- gsub(x = names(all_data), pattern = "\\.x", replacement = "_X")
names(all_data) <- gsub(x = names(all_data), pattern = "\\.", replacement = "_PRCT")
names(all_data) <- gsub(x = names(all_data), pattern = "collage", replacement = "college_X")
rookies <- all_data %>%
  group_by(Player) %>%
  arrange(year_start) %>%
  filter(row_number()==1)%>%
  arrange(salary) %>%
  filter(row_number() %in% seq(1,10,1)) %>%
  ungroup()
rookies$X3P_PRCT[is.na(rookies$X3P_PRCT)] <- 0
rookies <- separate(rookies, Pos_Y, into=c('Pos','Alt_pos'))
rookies_stats <- rookies %>%
  select(c('Pos','FG_PRCT','AST_PRCT','TS_PRCT','FT_PRCT','X3P_PRCT','X2P_PRCT','TOV_PRCT','ORB','DRB','STL','BLK', 'FG', 'FT', 'G', 'AST')) %>%
  mutate(RBA_A=(ORB + DRB) / G,
         STL_A=STL/G,
         BLK_A=BLK/G,
         FG_A=FG/G,
         FT_A=FT/G,
         AST_A=AST/G)
evan_rookie_stats <- rookies_stats
rookies_safe <- rookies
```

## Team Members (Full name):  
  * Brian Bates  
  * Maxwell Farver (Project Coordinator)
  * Evan Mills  
  * Ravi Patel  

***
## Goal:
The goal of this project Was to determine the key skills that players in the NBA today have, and what skills players need to develop in order to get drafted into the NBA.

### Questions Rasied:
This goal ultimately set us out to answer the following questions:

  1. What skills should you work on to be competitive in the NBA?
  2. What do teams look for in a possible top draft pick?
    + Body Composition (Height, Weight)
    + Skills (measured by stats)
    + Which schools contribute the most top talent to the NBA
  3. To be a top draft pick in your position, how well should you be performing on the court?

***
## Data Sets Used:
For our analysis we used three different data sets. The first data set we used was one that covered team stats between the years 2014 and 2018. We got this data set from Kaggle, since it was from kaggle it was mostly clean we just had to select what we needed based on what we were focusing on.
The second data set we used was also from Kaggle and covered stats for every player in the NBA since 1950 to 2018. Since this data set was rather large it came in multiple CSV files so the first thing we did after loading them in was a series of joins so all of the player data was in one data frame. This allowed us to easily select all of the data for the players that we were looking at.
Our third data set we used we got from Data.World. This data set covered all of the salary information for each player for the years between 1990 and 2018.

## What do teams look for in a possible top draft pick?

#### Body Composition (Height, Weight):

```{r warning=FALSE, include=FALSE}
years1 <- all_data
years1$X3P_PRCT[is.na(years1$X3P_PRCT)] <- 0
years1 <- na.omit(all_data)

years1 <- separate(years1, Pos_Y, into=c("position", "alt_position"), sep="-")

years2 <- years1 %>%
  group_by(season_start) %>%
  summarize(
    PTS = mean(PTS),
    AST = mean(AST_PRCT),
    TRB = mean(TRB_PRCT),
    STL = mean(STL_PRCT),
    BLK = mean(BLK_PRCT),
    FG = mean(FG_PRCT),
    X3P = mean(X3P_PRCT),
    X3PA = mean(X3PA),
    FT = mean(FT_PRCT)
  )
```

Shown in Figure 1 is the average height for an nba player in inches categorized by position. The figure shows that the PG(Point Guard) is the smallest position and the C(Center) is the tallest position. This figures shows the variation in height for each position.
```{r echo=FALSE, message=FALSE, warning=FALSE}
body <- years1 %>%
  group_by(Player) %>%
  summarise(
    height = mean(height_Y),
    weight = mean(weight_Y),
    position = dplyr::first(position)
  )

body[ , "height"] <- body[ , "height"] * 0.39370
body[ , "weight"] <- body[ , "weight"] * 2.20462
body <- separate(body, position, into=c("position", "alt_position"), sep="-")

ggplot(body, aes(x=position, y=height, fill=position)) + 
  geom_boxplot() +
  labs(
    title = "Body Height by Position",
    x = "Position",
    y = "Height in Inches",
    capition = "Figure 1. Body Height by Position"
  )
```

Figure 2 displays two key stats over the years; FG%(Field Goal Percentage), the number of shots made by a player divided by the number of shots attempted by a player, and x3P(3-Point Percentage), similar to FG% but counts shot made over attempted per player. The FG% is consistently declining from 1990 to 2005 then beings to steadily incline back up form 2005 to 2017. It is unclear as to why there is a consistent decease and increase, however it is a noticeable trend. For 3P% there has been a steady increase form 22% in 1990 to 30% in 2017, showing that the average player is more skilled at shooting 3-pointers over the years. 
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(reshape2)

years3 <- years1 %>%
  group_by(season_start) %>%
  summarize(
    FG = mean(FG_PRCT),
    X3P = mean(X3P_PRCT),
  ) 

melted <- melt(years3, id.var="season_start")

ggplot(melted, aes(x=season_start, y=value, color=variable)) + 
  geom_point() +
  geom_line() +
  labs(
    title = "Key Stats over the Years",
    x = "Year",
    y = "Percent",
    color = "Statistic",
    caption = "Figure 2. Key Stats over the Years"
  )
```

Figure 3 compares the number of 3-pointers attempted by each position over the years. PG, SG, and SF all follow the same trend and attempt similar number of threes. However the key position to look at is the PF(Power Forward). The PF is a position which played similar to the C(Center) in the 1990. However, looking at 2017 the PF had a significant increase in the number of the threes attempted compared to the C which had a minimal increase. 
```{r echo=FALSE, message=FALSE, warning=FALSE}
stretch <- years1 %>%
  group_by(season_start, position) %>%
  summarise(
    three = mean(X3PA)
  )

ggplot(stretch, aes(x=season_start, y=three, color=position)) + 
  geom_line() +
  geom_point() +
  labs(
    title = "3-Point Attempts over the Years by Position",
    x = "Year",
    y = "3-Point Attempts",
    color = "Position",
    caption = "Figure 3. 3-Point Attempts over the Years by Position"
  )
```

#### Which schools contribute the most top talent to the NBA:

***
## To be a top draft pick in your position, how well should you be performing on the court?
### Maxwell Farver

#### Top 5 Most Important Skills

 + Point Percentage
 + Free Throw Percentage
 + True Shooting Percentage  => PTS / (2 * (FGatt + 0.44 * FTatt) )
 + Field Goal Count
 + Steals



```{r echo=FALSE, message=FALSE, warning=FALSE}
rookie_stats <- rookies_safe %>%
  select(c('Pos','AST','FG_PRCT','AST_PRCT','TS_PRCT','FT_PRCT','X3P_PRCT','X2P_PRCT','TOV_PRCT','ORB','DRB','STL','BLK', 'FG', 'FT', 'G')) %>%
  mutate(RBA_A=(ORB + DRB) / G,
         AST_A=AST/G,
         STL_A=STL/G,
         BLK_A=BLK/G,
         FG_A=FG/G,
         FT_A=FT/G)
rookie_stats <- na.omit(rookie_stats)
```

*All of the data for the next three graphics consists of a subset of our data containing the stats of rookies that were drafted within the first 10 picks of the first round.*


*Figure 4* depicts the Free Throw percentage for the selected rookies. It can easily be seen that the positions where taller guys play tend to have a lower shooting percentage (C,PF). Our interpretation of this was that these players tend to play closer to the basket and may not get as much practice shooting from a distance, so they have more trouble at the line.
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(rookie_stats) + 
  geom_boxplot(mapping=aes(x=Pos, y=FT_PRCT, fill=Pos)) + 
  ggtitle('Free Throw Percentage by Position') + 
  xlab('Position') +
  ylab('Free Throw Percentage') +
  labs(caption= 'Figure 4. Free Throw Percentage by Position')
```


In *Figure 5* you can see that while Free Throw Percentage was different for each position, True Shooting Percentage tended to be more evenly dispersed. This makes sense if you think about it, as True Shooting Percentage was created to be a value that represented the entirety of a players shooting, or the impact they directly had on the offense. If a certain position tended to lag behind in this stat, it is very likely that said position would eventually die out and no longer be played by coaches around the league.
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(rookie_stats) + 
  geom_boxplot(mapping=aes(x=Pos, y=TS_PRCT, fill=Pos)) + 
  ggtitle('True Shooting Percentage by Position') +
  xlab('Position') +
  ylab('True Shooting Percentage') +
  labs(caption= 'Figure 5. True Shooting Percentage by Position')
```


The Average Number of Steals per position is shown in *Figure 6*. Steals can cause a swing in momentum in a game due to the high likelihood of a breakaway with an easy score for the team who stole the ball. This can cause a potential six point swing and quickly close the gap between two teams. Smaller players tended to have more steals on average than larger players, due to the fact that the smaller players play defense around teh paremeter where the ball is being dribbled more, leading to more opportunities for steals.
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(rookie_stats) + 
  geom_boxplot(mapping=aes(x=Pos, y=STL_A, fill=Pos)) + 
  ggtitle('Average Steals by Position') + 
  xlab('Position') +
  ylab('Average Steals') +
  labs(caption= 'Figure 6. Average Steals by Position')
```


## Things WE Thought Were Important
### Evan Mills


Most players when they enter the NBA already have a specific position in mind. Due to the various roles each position plays during a basketball game leads to some stats being more position based than others. In this section I will examine theses stats for the rookies in the NBA. The first stat that I explored was the average number of blocks per game. I chose this stat since a block denies the offensive team a shot and usually results in a turn over. Due to this blocks can play a crucial part of defense. As seen in *Figure 7* below, the number of blocks is significantly higher for players who play as a center(c) or power forward(PF). The reason for this is due to where these players typically are located on the court and the players body composition. The position of center and power forward are typically play closer to the basket, since they are closer to the basket they have more opportunities to get a blocked shot. The body composition of the players also play a major part since the center and power forwards are the larger players which gives them an advantage when it comes to being able to hit the ball out of the air.
```{r echo=FALSE, warning=FALSE}
evan_rookie_stats <- na.omit(evan_rookie_stats)
ggplot(evan_rookie_stats, aes(x = Pos, y = BLK_A, fill = Pos)) + geom_boxplot() + xlab("Position") + ylab("Block Average") + ggtitle("Average Blocks by Position") + labs(caption = "Figure 7. The average number of blocks in a game for each positon")
```

The second stat that I looked into was the average number of rebounds per game. I chose rebounds since a rebounds decide who gets possession of the ball after a missed shot. Since you can only score when you have possession of the ball the more rebounds a team gets the more opportunities that a team has to score, and ultimately lead to more baskets being made. *Figure 8* below shows the verge number of rebounds each position gets per game, and it shows that like before the players in playing center(C) and power forward(PF) have the highest average rebounds per game. These results also are because of the location of the players on the court and the body composition.
```{r echo=FALSE, warning=FALSE}
ggplot(evan_rookie_stats, aes(x = Pos, y = RBA_A, fill = Pos)) + geom_boxplot() + xlab("Position") + ylab("Rebound Average") + ggtitle("Average Rebounds by Position") + labs(caption = "Figure 8. The average number of rebounds in a game for each position")
```

The final stat that I looked at was the average assists per game. I chose this stat since an assist is a pass that results in the offense scoring a basket. Due to this definition assists are directly related to the over all score (i.e. the more assists a team has the more points they will have). *Figure 9* shows the average assists per game by position. As seen the position that has the most assists is the point guard(PG) and the small forward(SF). When you look at what these positions do you see that these players tend to dribble the ball up the court and play further away the basket. Because of this they tend to pass the ball to the players who tend to play closer to the basket and who have a better chance at making a shot.
```{r echo=FALSE, warning=FALSE}
ggplot(evan_rookie_stats, aes(x = Pos, y = AST_A, fill = Pos)) + geom_boxplot() + xlab("Position") + ylab("Assist Average") + ggtitle("Average Assists by Position") + labs(caption = "Figure 9. The average number of assists in a game for each position")
```

***
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
#(list=ls())
library(tidyverse)
library(RColorBrewer)
library(ggthemes)
```

## University Education
### Brian Bates

#### Background

If you want to play in the NBA you have to go to College for at least one year.  One question we proposed was, "<i>Where</i> should you go to College?" or alternatively, "Which Colleges have contributed the most top draft picks in the NBA?"  Remember, the underlying assumption we used is that the higher the salary of a player in their first year, the higher they likely went in the draft.  Lastly, it's important to note the data has been filtered down to the last ten years.  This was done so that up-and-coming schools, such as Iowa State, which have not been traditional power houses in NCAA basketball, will not be drowned out by the schools that have been elite for some time.

#### Producing the Map

This visualization was particularly challenging to construct due to the number of data sets needed to produce the map.  In addition to those needed to produce Rookie data, this map required **three** additional datasets to link the player's School with plottable data.  Data on Rookie players only included the name of the institution to which they attended.  Downloading and parsing data from the Department of Education, which shows over 31,000 accredited upper-level institutions, can be merged with Rookie data to find which states the schools are in.  Finally, the dataset can be combined with a dataset containing state abbreviations and then the regular map data used to produce choropleth maps.

#### Interpretation

The map in Figure 10 is clear as to which States contribute the most to top draft picks, however, because the schools are hidden in the State it doesn't answer the original question of which *school*.  This issue is further explored below in challenges.  

Far more questions were raised by the map than were answered.  For instance, why are so many power schools in the Southern half of the United States?  Is it that nearly year-round temperate weather facilitates more playing and thus better skills?  What is the relation of school size or history to contributions?  Do we see an up-and-coming schools, such as Iowa State, showing up in the last ten years?  Clearly the map is a stepping-stone for further exploration.  

#### Challenges

Ultimately, there are some improvements to be made with the map.  First, it does not directly answer our question of which *schools* contribute the most, but rather which states house the schools that produce the most.  With so many schools on the map, it became too cluttered and the choice was made to switch to showing the States which hold those schools.  This is not an unreasonable switch to make, since elite NCAA schools will likely have ancillary support in the area - from prep-schools, training facilities, medical professionals and more.  It is easy to see that the more elite a school is, the more surrounding schools may contribute as well and the same "hubs" still form; these hubs are now represented in State contributions.

Additionally, the contribution measure itself is a weighted percent of *salaries* and not the *number* of contributions.  Creating both maps to compare results would have been a good idea.

#### Datasets for Map
Database of Accredited Postsecondary Institutions and Programs
Source: https://ope.ed.gov/dapip/#/download-data-files

State Abbreviations
Source:  https://abbreviations.yourdictionary.com/articles/state-abbrev.html


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Dimension reduction of Rookie data
rookie.data <- rookies_safe %>% 
  filter(year_start >= 2009) %>%
  select(Player, year_start, college, salary) %>%
  rename(School = college)
str(rookie.data)
```


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Collecting a list of school from US Department of Education.
institutions <- read.csv("institutions.csv", stringsAsFactors = FALSE)

# Dimension reduction
schools <- institutions %>% select(LocationName, Address)

# Rename columns
colnames(schools) <- c("School", "Location")

# Split the location to get the city and state
schools <- schools %>% mutate(StateZip = str_extract(Location, "[A-Z]{2}\\s\\d{5}")) %>%
            separate(StateZip, c("State", "Zip")) %>%
            mutate(CityState = str_extract(Location, "[a-z,A-Z]+,\\s[A-Z]{2}")) %>%
            separate(CityState, c("City", "Misc"), sep=",") %>%
            select(-Misc)

str(schools)

```


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Join School & Rookie
rookies.schools <- inner_join(rookie.data, schools, by="School")
str(rookies.schools)
```


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Load in a CSV file containing states names and their abbreviations
state_abbr <- read.csv("state_abbr.csv", stringsAsFactors = FALSE)
colnames(state_abbr)[1] <- 'States'

state_abbr <- state_abbr %>% separate(States, c("Region", "State"), sep=" - ") %>%
                             mutate(Region = tolower(Region)) %>%
                             rename(region = Region) 

#str(state_abbr)

# Load in other state data
states <- map_data('state') %>%
  select(-subregion)
#str(states)

# Merge the two groups by region
state.data <- states %>% group_by(region) %>%
                  inner_join(state_abbr, by="region") %>%
                  ungroup()
#str(state.data)

# Merge rookie.schools & states
map.data <- inner_join(rookies.schools, state.data, by="State")

map.data.1997 <- map.data %>% filter(year_start == 1997)
```


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Remove NAs
map.data <- map.data %>% mutate_all(~replace(., is.na(.), 0)) 

final.data <- state_abbr
final.data$Salary = rep(0, 50)

# Aggregate the total salary for each state
for (i in seq(final.data$State)) {
  active.state <- final.data$State[i]
  
  state.map.data <- map.data %>% filter(State == active.state)    
  
  final.data$Salary[i] = sum(state.map.data$salary)
}

# Determine the total salary
Total.Salary <- sum(final.data$Salary)

# Convert total salary to percentage
final.data <- final.data %>% mutate(Percent = Salary / Total.Salary)
# str(final.data)

# final.data$cut <- as.character(cut(final.data$Percent,
#                                   breaks=pretty(x=final.data$Percent, n=10),
#                                   labels=pretty(x=final.data$Percent, n=10)[-1],
#                                   ordered_result=TRUE))

gg <- ggplot()
gg <- gg + geom_map(data=states, map=states, aes(x=long, y=lat, map_id=region), color="white", size=0.15, fill=NA)
gg <- gg + geom_map(data=final.data, map=states, aes(fill=Percent, map_id=region), color="white", size=0.15)
# gg <- gg + scale_fill_brewer(name="% Players",
#                              labels = seq(10, 0, -1),
#                              palette="BuGn",
#                              na.value = "#eaf7fb",
#                              direction=-1) #, discrete=TRUE, begin=0.1, end=0.9
gg <- gg + scale_fill_gradient(name="Players",
                    # labels = seq(1, 10),
                    low="#4ba7f5", 
                    high="#13273a")
gg <- gg + coord_map("polyconic")
gg <- gg + theme_map()
gg <- gg + theme(legend.position="right")
gg <- gg + labs(caption="Figure 10. Map of schools by contribution to top NBA draft picks.")
gg
```


***
## Conclusion:
We had one main goal in mind when it came to this project. 

### So You Want To Play in the NBA

The things that we determined to be the biggest factors in succeeding in your endeavor are:

 + Be a good shooter
 + Be aggressive (take a lot of shots)
 + Force Turnovers
   - Steals
   - Blocks
 + Be taller that 6-foot, especially for post players
 + Play to your position's strengths
   - Point Gaurd: Focus on passing
   - Center: Focus on rebounds and blocks
 + Look at schools located in:
   - Texas
   - California
   - Washington
   - Kentucky
   - North Carolina
   - Florida
   
Do these things and with a little bit of luck you are well on your way to playing in the NBA.


***
## Contributions:
#### Brian Bates 


#### Maxwell Farver (Project Coordinator)
My contribution to the project consisted of a few things (as well as help with the final report, but everyone helped with it). I first helped clean the data initially for everyone to work off of. I then found out the most common skills among top players in the NBA. Lastly, I plotted a few of the most important skills to find out what conclusions we could draw from them.


#### Evan Mills 

For this project I was handled some of the data cleaning. This included importing the data form the CSV files and combining the correct data frames, and removing duplicate and missing data. Along with this I analysed the stats that were specific for each position when getting drafted. This included getting the relevant data and creating relevant plots to go with it. 

#### Ravi Patel 

***
## Sources:
### Data Sets:
  * Game Stats for years between 2014 and 2018:
    + https://www.kaggle.com/ionaskel/nba-games-stats-from-2014-to-2018  
  * Statistics on players since 1950:
    + https://www.kaggle.com/drgilermo/nba-players-stats 
  * Salary data for each player since 1990:
    + https://data.world/datadavis/nba-salaries 
    
### Referenced Items:
  * Rmd Cheat Sheet:
    + https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf


