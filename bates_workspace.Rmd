---
title: "Max Workspace"
output: html_notebook
---


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
rm(list=ls())
library(tidyverse)
library(RColorBrewer)
library(ggthemes)
```

## University Education

#### Background

If you want to play in the NBA you have to go to College for at least one year.  One question we proposed was, "<i>Where</i> should you go to College?" or alternatively, "Which Colleges have contributed the most top draft picks in the NBA?"  Remember, the underlying assumption we used is that the higher the salary of a player in their first year, the higher they likely went in the draft.  Lastly, it's important to note the data has been filtered down to the last ten years.  This was done so that up-and-coming schools, such as Iowa State, which have not been traditional power houses in NCAA basketball, will not be drowned out by the schools that have been elite for some time.

#### Producing the Map

This visualization was particularly challenging to construct due to the number of data sets needed to produce the map.  In addition to those needed to produce Rookie data, this map required **three** additional datasets to link the player's School with plottable data.  Data on Rookie players only included the name of the institution to which they attended.  Downloading and parsing data from the Department of Education, which shows over 31,000 accredited upper-level institutions, can be merged with Rookie data to find which states the schools are in.  Finally, the dataset can be combined with a dataset containing state abbreviations and then the regular map data used to produce choropleth maps.

#### Interpretation

The map in Figure 10 is clear as to which States contribute the most to top draft picks, however, because the schools are hidden in the State it doesn't answer the original question of which *school*.  This issue is further explored below in challenges.  

Far more questions were raised by the map than were answered.  For instance, why are so many power schools in the Southern half of the United States?  Is it that nearly year-round temperate weather facilitates more playing and thus better skills?  What is the relation of school size or history to contributions?  Do we see an up-and-coming schools, such as Iowa State, showing up in the last ten years?  Clearly the map is a stepping-stone for further exploration.  

#### Challenges

Ultimately, there are some improvements to be made with the map.  First, it does not directly answer our question of which *schools* contribute the most, but rather which states house the schools that produce the most.  With so many schools on the map, it became too cluttered and the choice was made to switch to showing the States which hold those schools.  This is not an unreasonable switch to make, since elite NCAA schools will likely have ancillary support in the area - from prep-schools, training facilities, medical professionals and more.  It is easy to see that the more elite a school is, the more surrounding schools may contribute as well and the same "hubs" still form; these hubs are now represented in State contributions.

Additionally, the contribution measure itself is a weighted percent of *salaries* and not the *number* of contributions.  Creating both maps to compare results would have been a good idea.

#### Datasets for Map
Database of Accredited Postsecondary Institutions and Programs
Source: https://ope.ed.gov/dapip/#/download-data-files

State Abbreviations
Source:  https://abbreviations.yourdictionary.com/articles/state-abbrev.html


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Dimension reduction of Rookie data
rookie.data <- rookies_safe %>% 
  filter(year_start >= 2009) %>%
  select(Player, year_start, college, salary) %>%
  rename(School = college)
str(rookie.data)
```


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Collecting a list of school from US Department of Education.
institutions <- read.csv("institutions.csv", stringsAsFactors = FALSE)

# Dimension reduction
schools <- institutions %>% select(LocationName, Address)

# Rename columns
colnames(schools) <- c("School", "Location")

# Split the location to get the city and state
schools <- schools %>% mutate(StateZip = str_extract(Location, "[A-Z]{2}\\s\\d{5}")) %>%
            separate(StateZip, c("State", "Zip")) %>%
            mutate(CityState = str_extract(Location, "[a-z,A-Z]+,\\s[A-Z]{2}")) %>%
            separate(CityState, c("City", "Misc"), sep=",") %>%
            select(-Misc)

str(schools)

```


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Join School & Rookie
rookies.schools <- inner_join(rookie.data, schools, by="School")
str(rookies.schools)
```


```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Load in a CSV file containing states names and their abbreviations
state_abbr <- read.csv("state_abbr.csv", stringsAsFactors = FALSE)

state_abbr <- state_abbr %>% separate(States, c("Region", "State"), sep=" - ") %>%
                             mutate(Region = tolower(Region)) %>%
                             rename(region = Region) 

#str(state_abbr)

# Load in other state data
states <- map_data('state') %>%
  select(-subregion)
#str(states)

# Merge the two groups by region
state.data <- states %>% group_by(region) %>%
                  inner_join(state_abbr, by="region") %>%
                  ungroup()
#str(state.data)

# Merge rookie.schools & states
map.data <- inner_join(rookies.schools, state.data, by="State")

map.data.1997 <- map.data %>% filter(year_start == 1997)
```


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Remove NAs
map.data <- map.data %>% mutate_all(~replace(., is.na(.), 0)) 

final.data <- state_abbr
final.data$Salary = rep(0, 50)

# Aggregate the total salary for each state
for (i in seq(final.data$State)) {
  active.state <- final.data$State[i]
  
  state.map.data <- map.data %>% filter(State == active.state)    
  
  final.data$Salary[i] = sum(state.map.data$salary)
}

# Determine the total salary
Total.Salary <- sum(final.data$Salary)

# Convert total salary to percentage
final.data <- final.data %>% mutate(Percent = Salary / Total.Salary)
# str(final.data)

# final.data$cut <- as.character(cut(final.data$Percent,
#                                   breaks=pretty(x=final.data$Percent, n=10),
#                                   labels=pretty(x=final.data$Percent, n=10)[-1],
#                                   ordered_result=TRUE))

gg <- ggplot()
gg <- gg + geom_map(data=states, map=states, aes(x=long, y=lat, map_id=region), color="white", size=0.15, fill=NA)
gg <- gg + geom_map(data=final.data, map=states, aes(fill=Percent, map_id=region), color="white", size=0.15)
# gg <- gg + scale_fill_brewer(name="% Players",
#                              labels = seq(10, 0, -1),
#                              palette="BuGn",
#                              na.value = "#eaf7fb",
#                              direction=-1) #, discrete=TRUE, begin=0.1, end=0.9
gg <- gg + scale_fill_gradient(name="Players",
                    # labels = seq(1, 10),
                    low="#4ba7f5", 
                    high="#13273a")
gg <- gg + coord_map("polyconic")
gg <- gg + theme_map()
gg <- gg + theme(legend.position="right")
gg <- gg + labs(caption="Figure 10. Map of schools by contribution to top NBA draft picks.")
gg
```

